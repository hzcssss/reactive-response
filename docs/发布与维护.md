# 发布与维护

本文档详细说明 `reactive-response` 项目的发布流程和维护策略，包括版本管理、依赖升级、问题报告处理等内容。

## 发布流程

### 版本号管理策略

本项目严格遵循语义化版本控制（Semantic Versioning）规范，版本号格式为 `主版本号.次版本号.修订号`：

- **主版本号（Major）**：当进行不兼容的 API 修改时递增
- **次版本号（Minor）**：当以向后兼容的方式添加新功能时递增
- **修订号（Patch）**：当进行向后兼容的问题修复时递增

#### 版本发布历史

根据 `CHANGELOG.md` 的记录，各版本变更如下：

##### 1.0.0 版本（2025-08-15）
- **新功能**：初始版本发布，提供响应式编程场景下的 API 响应包装功能
- **核心能力**：支持 Mono 和 Flux 的响应包装、链式调用 API、集成 Spring Boot 自动配置

##### 1.0.1 版本（2025-08-30）
- **修复**：解决了 Spring Boot 自动注入问题，修复了 "Could not autowire. No beans of 'SpringReactiveResponseBuilder' type found" 错误
- **改进**：改进了资源打包配置，确保资源文件正确打包

##### 1.0.2 版本（2025-09-03）
- **修复**：修复了 Spring Boot 自动配置类的问题，确保在所有环境下都能正确注册 `SpringReactiveResponseBuilder` bean
- **改进**：添加了 `@ComponentScan` 注解，确保扫描到库中的所有组件；移除了条件限制，使自动配置在所有环境下都能生效
- **增强**：添加了日志记录，帮助调试自动配置过程；支持 Spring Boot 2.7+ 的新自动配置机制

### 发布前准备

#### 1. 代码质量检查

```bash
# 运行所有测试
mvn clean test

# 代码覆盖率检查
mvn jacoco:report

# 静态代码分析（如果配置了 SpotBugs 等工具）
mvn spotbugs:check
```

#### 2. 文档更新

在发布新版本前，确保以下文档已更新：

- **`CHANGELOG.md`**：记录所有变更
- **`README.md`**：更新版本号和新功能说明
- **API 文档**：确保新增或修改的 API 有完整文档
- **Wiki 文档**：同步更新相关使用指南

#### 3. 版本号更新

更新 `pom.xml` 中的版本号：

```xml
<groupId>io.github.hzcssss</groupId>
<artifactId>reactive-response-builder</artifactId>
<version>1.0.3</version> <!-- 更新到新版本 -->
```

### 发布到 Maven 中央仓库

#### 前提条件

1. **Sonatype 账号**：在 [Sonatype OSSRH](https://oss.sonatype.org) 注册账号
2. **GPG 密钥**：生成 GPG 密钥对用于构件签名
3. **Maven 配置**：在 `~/.m2/settings.xml` 中配置认证信息

#### GPG 密钥配置

```bash
# 生成 GPG 密钥对
gpg --full-generate-key

# 查看生成的密钥
gpg --list-keys
gpg --list-keys --keyid-format LONG

# 发布密钥到公钥服务器
gpg --keyserver hkp://keyserver.ubuntu.com --send-keys YOUR_KEY_ID
gpg --keyserver hkp://pool.sks-keyservers.net --send-keys YOUR_KEY_ID
```

#### Maven 配置

在 `~/.m2/settings.xml` 中添加服务器配置：

```xml
<settings>
    <servers>
        <server>
            <id>central</id>
            <username>your-sonatype-username</username>
            <password>your-sonatype-password</password>
        </server>
    </servers>
    
    <profiles>
        <profile>
            <id>gpg</id>
            <properties>
                <gpg.executable>gpg</gpg.executable>
                <gpg.keyname>YOUR_KEY_ID</gpg.keyname>
                <gpg.passphrase>your-gpg-passphrase</gpg.passphrase>
            </properties>
        </profile>
    </profiles>
</settings>
```

#### 发布命令

```bash
# 清理并构建
mvn clean install

# 发布到 Maven 中央仓库
mvn clean deploy -P wYOw2G

# 如果需要手动提供 GPG 密码
mvn clean deploy -P wYOw2G -Dgpg.passphrase=your-gpg-passphrase
```

#### 发布后验证

1. **检查 Sonatype**：访问 [Sonatype Repository](https://oss.sonatype.org) 确认构件已上传
2. **等待同步**：Maven 中央仓库同步通常需要几个小时
3. **验证可用性**：在 [Maven Search](https://search.maven.org) 搜索新版本

## 维护策略

### 依赖管理

#### 上游依赖分析

本项目依赖以下上游库：

1. **Reactor Core**
   - `groupId`: io.projectreactor
   - `artifactId`: reactor-core
   - `version`: 3.4.0
   - 作用：提供响应式编程基础支持

2. **Spring Boot 相关依赖**
   - `spring-boot-autoconfigure`：提供自动配置支持
   - `spring-boot-configuration-processor`：支持配置属性处理
   - `spring-webflux`：提供 WebFlux 支持
   - 所有 Spring 相关依赖均标记为 `provided` 和 `optional`

3. **测试依赖**
   - `reactor-test`：Reactor 测试支持
   - `junit-jupiter-api` 和 `junit-jupiter-engine`：JUnit 5 测试框架
   - `spring-boot-starter-test`：Spring Boot 测试支持

#### 依赖升级策略

1. **版本属性管理**
   所有依赖版本通过 `<properties>` 标签集中管理：
   
   ```xml
   <properties>
       <reactor.version>3.4.0</reactor.version>
       <junit.version>5.10.0</junit.version>
       <spring-boot.version>2.7.18</spring-boot.version>
   </properties>
   ```

2. **升级流程**
   - **评估兼容性**：检查新版本与现有代码的兼容性
   - **更新版本属性**：修改 `pom.xml` 中的版本属性
   - **运行测试**：执行 `mvn clean test` 确保所有测试通过
   - **本地验证**：使用 `mvn clean install` 在本地安装并测试
   - **发布新版本**：按照发布流程发布新版本

3. **Spring Boot 版本兼容性**
   - 本库设计为与多种 Spring Boot 版本兼容
   - 所有 Spring 相关依赖标记为 `provided` 和 `optional`，避免版本冲突
   - 已测试兼容 Spring Boot 2.7.x 版本
   - 理论上兼容 Spring Boot 3.x（需要 Java 17+）

#### 版本冲突排查

当遇到版本冲突时，建议采取以下排查步骤：

1. 检查项目中实际使用的 Spring Boot 版本是否在推荐范围内
2. 使用 Maven 的 `dependency:tree` 命令分析依赖树：
   ```bash
   mvn dependency:tree -Dincludes=io.github.hzcssss:reactive-response-builder
   ```
3. 如果存在冲突，可以通过 `dependencyManagement` 显式指定兼容版本
4. 确保项目中只有一个版本的 Reactor Core 库
5. 在测试环境中验证响应构建功能的正确性

### 问题报告与处理

#### 问题分类

1. **Bug 报告**：功能异常或错误行为
2. **功能请求**：新功能建议
3. **文档问题**：文档错误或缺失
4. **性能问题**：性能瓶颈或优化建议

#### 报告模板

##### Bug 报告模板

```markdown
**Bug 描述**
简要描述遇到的问题。

**复现步骤**
1. 导入依赖版本：1.0.2
2. 创建 SpringReactiveResponseBuilder
3. 调用 from() 方法
4. 观察到错误

**期望行为**
描述你期望发生什么。

**实际行为**
描述实际发生了什么。

**环境信息**
- Java 版本：11
- Spring Boot 版本：2.7.18
- reactive-response 版本：1.0.2
- 操作系统：macOS 13.0

**错误日志**
```
粘贴相关的错误日志
```

**其他信息**
添加其他有助于解决问题的信息。
```

##### 功能请求模板

```markdown
**功能描述**
描述你希望添加的功能。

**使用场景**
解释为什么需要这个功能，它解决了什么问题。

**建议的实现方式**
如果有想法，可以描述建议的实现方式。

**替代方案**
描述你考虑过的其他解决方案。
```

#### 处理流程

1. **问题分类**：根据问题类型进行分类和优先级排序
2. **问题确认**：尝试复现问题，确认问题的有效性
3. **分析原因**：分析问题的根本原因
4. **制定方案**：制定解决方案或改进计划
5. **实施修复**：实施修复并进行测试
6. **发布修复**：将修复包含在下一个版本中
7. **用户反馈**：收集用户对修复的反馈

### 代码贡献指南

#### 开发环境搭建

1. **克隆项目**
   ```bash
   git clone https://github.com/hzcssss/reactive-response.git
   cd reactive-response
   ```

2. **安装依赖**
   ```bash
   mvn clean install
   ```

3. **运行测试**
   ```bash
   mvn test
   ```

#### 开发规范

1. **代码风格**
   - 遵循 Google Java Style Guide
   - 使用 4 个空格缩进
   - 方法和类名使用驼峰命名法
   - 常量使用大写字母和下划线

2. **提交规范**
   使用 Conventional Commits 规范：
   ```
   <type>[optional scope]: <description>
   
   [optional body]
   
   [optional footer(s)]
   ```
   
   类型包括：
   - `feat`: 新功能
   - `fix`: Bug 修复
   - `docs`: 文档更新
   - `style`: 代码格式化
   - `refactor`: 代码重构
   - `test`: 测试相关
   - `chore`: 构建过程或辅助工具的变动

3. **分支策略**
   - `main`: 主分支，保持稳定
   - `develop`: 开发分支
   - `feature/xxx`: 功能分支
   - `hotfix/xxx`: 热修复分支

#### Pull Request 流程

1. **创建分支**
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **开发和测试**
   - 实现功能
   - 编写测试用例
   - 确保所有测试通过

3. **提交变更**
   ```bash
   git add .
   git commit -m "feat: add new response mapping feature"
   git push origin feature/your-feature-name
   ```

4. **创建 Pull Request**
   - 在 GitHub 上创建 Pull Request
   - 填写详细的描述和变更说明
   - 关联相关的 Issue

5. **代码审查**
   - 等待维护者进行代码审查
   - 根据反馈进行修改
   - 确保 CI 检查通过

### 持续集成和持续部署

#### GitHub Actions 配置

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [11, 17, 21]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
    
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        
    - name: Run tests
      run: mvn clean verify
      
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
        
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Import GPG key
      uses: crazy-max/ghaction-import-gpg@v5
      with:
        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
        passphrase: ${{ secrets.GPG_PASSPHRASE }}
        
    - name: Deploy to Maven Central
      run: mvn clean deploy -P wYOw2G
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
```

#### 质量门控

1. **代码覆盖率**：要求测试覆盖率不低于 80%
2. **静态分析**：确保没有严重的代码质量问题
3. **安全扫描**：检查已知的安全漏洞
4. **兼容性测试**：在多个 Java 版本上运行测试

### 长期维护计划

#### 技术债务管理

1. **定期重构**：每个大版本周期进行一次代码重构
2. **依赖更新**：每季度评估和更新依赖版本
3. **性能优化**：基于用户反馈持续优化性能
4. **API 演进**：谨慎地演进 API，保持向后兼容性

#### 社区建设

1. **文档维护**：保持文档的及时更新和准确性
2. **示例代码**：提供丰富的使用示例和最佳实践
3. **社区支持**：积极回应社区问题和建议
4. **技术分享**：通过博客、会议等方式分享技术心得

#### 路线图规划

##### 短期目标（3-6个月）
- 完善错误处理机制
- 添加更多的响应转换工具
- 改进性能监控能力
- 支持更多的 Spring Boot 版本

##### 中期目标（6-12个月）
- 添加响应缓存支持
- 实现响应数据压缩
- 支持自定义序列化
- 添加指标收集和监控

##### 长期目标（1年以上）
- 支持响应式数据库集成
- 实现分布式追踪支持
- 添加多语言国际化支持
- 开发可视化监控面板

---

*本文档将随着项目的发展持续更新。如有任何建议或问题，请在 [GitHub Issues](https://github.com/hzcssss/reactive-response/issues) 中提出。*